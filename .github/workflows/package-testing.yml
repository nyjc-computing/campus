name: Package Testing

on:
  push:
    branches: [main, campus-subpackaging]
  pull_request:
    branches: [main]

jobs:
  # First, test that all packages can be built independently
  build-packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ["common", "vault", "storage", "client", "models", "apps", "workspace"]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          
      - name: Test package build - ${{ matrix.package }}
        run: |
          cd campus/${{ matrix.package }}
          echo "📦 Building campus-${{ matrix.package }}..."
          poetry install
          poetry build
          echo "✅ Successfully built campus-${{ matrix.package }}"
          
      - name: Verify package contents
        run: |
          cd campus/${{ matrix.package }}
          ls -la dist/
          echo "📋 Package files created:"
          find dist/ -name "*.whl" -o -name "*.tar.gz"

  # Test package imports work in isolation
  test-package-imports:
    runs-on: ubuntu-latest
    needs: build-packages
    strategy:
      matrix:
        package: ["common", "vault", "client"]  # Start with independent packages
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          
      - name: Test isolated import - ${{ matrix.package }}
        run: |
          cd campus/${{ matrix.package }}
          poetry install
          echo "🧪 Testing isolated import of campus.${{ matrix.package }}..."
          poetry run python -c "
          import sys
          try:
              import campus.${{ matrix.package }}
              print('✅ Successfully imported campus.${{ matrix.package }}')
          except ImportError as e:
              print(f'❌ Failed to import campus.${{ matrix.package }}: {e}')
              sys.exit(1)
          "

  # Test dependency resolution across packages
  test-dependency-chain:
    runs-on: ubuntu-latest
    needs: build-packages
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          
      - name: Test dependency chain
        run: |
          echo "🔗 Testing dependency chain: vault → storage → apps"
          
          # Test vault (should only need common)
          cd campus/vault
          poetry install
          echo "✅ campus-vault dependencies resolved"
          
          # Test storage (needs vault + common)
          cd ../storage
          poetry install
          echo "✅ campus-storage dependencies resolved"
          
          # Test apps (needs all packages)
          cd ../apps
          poetry install
          echo "✅ campus-apps dependencies resolved"
          
          echo "🎉 All dependency chains working!"

  # Integration test: verify the workspace package works
  test-workspace-integration:
    runs-on: ubuntu-latest
    needs: [build-packages, test-package-imports]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          
      - name: Test workspace package
        run: |
          cd campus/workspace
          poetry install
          echo "🏢 Testing workspace integration..."
          poetry run python -c "
          import sys
          try:
              import campus.workspace
              print('✅ campus.workspace imports successfully')
              
              # Test that individual modules are available
              import campus.common
              import campus.vault
              print('✅ Individual modules accessible through workspace')
              
          except ImportError as e:
              print(f'❌ Workspace integration failed: {e}')
              sys.exit(1)
          "

  # Summary job that depends on all others
  package-testing-summary:
    runs-on: ubuntu-latest
    needs: [build-packages, test-package-imports, test-dependency-chain, test-workspace-integration]
    if: always()
    
    steps:
      - name: Check all package tests
        run: |
          echo "📊 Package Testing Summary:"
          echo "✅ Build packages: ${{ needs.build-packages.result }}"
          echo "✅ Import tests: ${{ needs.test-package-imports.result }}"
          echo "✅ Dependency chain: ${{ needs.test-dependency-chain.result }}"
          echo "✅ Workspace integration: ${{ needs.test-workspace-integration.result }}"
          
          if [[ "${{ needs.build-packages.result }}" != "success" || 
                "${{ needs.test-package-imports.result }}" != "success" || 
                "${{ needs.test-dependency-chain.result }}" != "success" || 
                "${{ needs.test-workspace-integration.result }}" != "success" ]]; then
            echo "❌ Some package tests failed"
            exit 1
          else
            echo "🎉 All package tests passed!"
          fi
